document.addEventListener("DOMContentLoaded",function(){window.roadmapSpreadsheets={};const h=(s=50,o=10)=>{let e=[];for(let t=0;t<s;t++){let n=[];for(let a=0;a<o;a++)n.push("");e.push(n)}return e},y=(s=10)=>{let o=[];for(let e=0;e<s;e++)o.push({type:"text",width:150});return o};window.initSpreadsheet=function(s){const o="roadmap-rekomendasi-container-"+s,e="roadmap-rekomendasi-data-"+s,t=document.getElementById(o),n=document.getElementById(e);if(console.log("[Roadmap] Init:",s,"Container:",!!t,"DataInput:",!!n),!t||!n)return;let a=null;try{const r=n.value;r&&(a=JSON.parse(r),console.log("[Roadmap] Loaded saved data:",a))}catch(r){console.error("[Roadmap] Error parsing saved data:",r)}let l=h(),i={},c={},d=y();a&&(a.cells&&Array.isArray(a.cells)?(l=a.cells,i=a.style||{},c=a.mergeCells||{},a.colWidths&&a.colWidths.length&&(d=a.colWidths.map(r=>({type:"text",width:r||150})))):Array.isArray(a)&&(l=a)),t.style.overflow="hidden",t.style.height="400px",t.style.border="1px solid #ddd",t.style.display="block";try{const r=jspreadsheet(t,{toolbar:!0,worksheets:[{data:l,style:i,mergeCells:c,minDimensions:[10,50],tableOverflow:!0,tableWidth:"calc(100% - 2px)",tableHeight:"350px",columnDrag:!0,rowDrag:!0,columnResize:!0,rowResize:!0,wordWrap:!0,columns:d}]});window.roadmapSpreadsheets[s]=r,console.log("[Roadmap] Spreadsheet initialized with styles:",s)}catch(r){console.error("[Roadmap] Error initializing spreadsheet:",r)}},window.getAllSpreadsheetData=function(s){const o=window.roadmapSpreadsheets[s];if(!o)return console.warn("[Roadmap] No spreadsheet instance found for:",s),null;try{const e=o[0];if(e){const t={cells:e.getData?e.getData():[],style:e.getStyle?e.getStyle():{},mergeCells:e.getMerge?e.getMerge():{},colWidths:[]};try{e.getWidth&&(t.colWidths=e.getWidth())}catch(n){console.warn("[Roadmap] Could not get column widths:",n)}return console.log("[Roadmap] Got full data for",s,":",t),t}return null}catch(e){return console.error("[Roadmap] Error getting data:",e),null}};const u=document.getElementById("flash-success");u&&Swal.fire({icon:"success",title:"Berhasil",text:u.dataset.message,timer:2e3,showConfirmButton:!1});const m=document.getElementById("flash-error");m&&Swal.fire({icon:"error",title:"Gagal",text:m.dataset.message});const p=document.getElementById("saveAllNotesBtn");p&&p.addEventListener("click",function(){const s=document.querySelectorAll('form[action*="save-note"]');if(s.length===0){Swal.fire({icon:"warning",title:"Tidak Ada Form",text:"Tidak ada catatan untuk disimpan."});return}let o=[],e=0;Swal.fire({title:"Menyimpan...",text:"Sedang menyimpan semua catatan",icon:"info",showConfirmButton:!1,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),s.forEach(t=>{const n=t.querySelector('input[name="objective_id"]');if(n){const c=n.value,d=getAllSpreadsheetData(c);console.log("[Roadmap] Saving - Objective:",c,"Spreadsheet Data:",d);const r=t.querySelector('input[name="roadmap_rekomendasi"]');r&&d&&(r.value=JSON.stringify(d))}const a=new FormData(t),l=t.getAttribute("action"),i=fetch(l,{method:"POST",body:a,headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(c=>(c.ok&&e++,c));o.push(i)}),Promise.all(o).then(()=>{Swal.fire({icon:"success",title:"Berhasil!",text:`${e} catatan berhasil disimpan.`,timer:2e3,showConfirmButton:!1})}).catch(t=>{console.error("Error:",t),Swal.fire({icon:"error",title:"Gagal",text:"Terjadi kesalahan saat menyimpan catatan."})})}),console.log("[Roadmap] Initializing spreadsheets..."),document.querySelectorAll('[id^="roadmap-rekomendasi-container-"]').forEach(s=>{const o=s.id.replace("roadmap-rekomendasi-container-","");initSpreadsheet(o)});const f=document.querySelectorAll('form[action*="summary.save-note"]');console.log("[Roadmap] Found forms:",f.length),f.forEach(function(s){s.addEventListener("submit",function(o){const e=s.querySelector('input[name="objective_id"]').value,t=getAllSpreadsheetData(e);console.log("[Roadmap] Form submit - Objective:",e,"Data:",t);const n=s.querySelector('input[name="roadmap_rekomendasi"]');n&&t&&(n.value=JSON.stringify(t))})}),document.querySelectorAll(".btn-group button[data-view]").forEach(s=>{s.addEventListener("click",function(){const o=this.dataset.view,e=this.dataset.target;this.closest(".btn-group").querySelectorAll("button").forEach(i=>{i.classList.remove("active"),i.dataset.view==="gamo"?(i.classList.remove("btn-primary"),i.classList.add("btn-outline-primary")):i.dataset.view==="practice"?(i.classList.remove("btn-secondary"),i.classList.add("btn-outline-secondary")):i.dataset.view==="activity"&&(i.classList.remove("btn-info"),i.classList.add("btn-outline-info"))}),this.classList.add("active"),o==="gamo"?(this.classList.remove("btn-outline-primary"),this.classList.add("btn-primary")):o==="practice"?(this.classList.remove("btn-outline-secondary"),this.classList.add("btn-secondary")):o==="activity"&&(this.classList.remove("btn-outline-info"),this.classList.add("btn-info"));const n=document.getElementById("view-gamo-"+e),a=document.getElementById("view-practice-"+e),l=document.getElementById("view-activity-"+e);o==="gamo"?(n&&(n.style.display="block"),a&&(a.style.display="none"),l&&(l.style.display="none")):o==="practice"?(n&&(n.style.display="none"),a&&(a.style.display="block"),l&&(l.style.display="none")):o==="activity"&&(n&&(n.style.display="none"),a&&(a.style.display="none"),l&&(l.style.display="block"))})})});
