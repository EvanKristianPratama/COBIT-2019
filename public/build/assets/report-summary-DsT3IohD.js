document.addEventListener("DOMContentLoaded",function(){window.roadmapSpreadsheets={};const g=(a=50,n=10)=>{let e=[];for(let t=0;t<a;t++){let s=[];for(let o=0;o<n;o++)s.push("");e.push(s)}return e},f=(a=10)=>{let n=[];for(let e=0;e<a;e++)n.push({type:"text",width:150});return n};window.initSpreadsheet=function(a){const n="roadmap-rekomendasi-container-"+a,e="roadmap-rekomendasi-data-"+a,t=document.getElementById(n),s=document.getElementById(e);if(console.log("[Roadmap] Init:",a,"Container:",!!t,"DataInput:",!!s),!t||!s)return;let o=null;try{const r=s.value;r&&(o=JSON.parse(r),console.log("[Roadmap] Loaded saved data:",o))}catch(r){console.error("[Roadmap] Error parsing saved data:",r)}let i=g(),d={},l={},c=f();o&&(o.cells&&Array.isArray(o.cells)?(i=o.cells,d=o.style||{},l=o.mergeCells||{},o.colWidths&&o.colWidths.length&&(c=o.colWidths.map(r=>({type:"text",width:r||150})))):Array.isArray(o)&&(i=o)),t.style.overflow="hidden",t.style.height="400px",t.style.border="1px solid #ddd",t.style.display="block";try{const r=jspreadsheet(t,{toolbar:!0,worksheets:[{data:i,style:d,mergeCells:l,minDimensions:[10,50],tableOverflow:!0,tableWidth:"calc(100% - 2px)",tableHeight:"350px",columnDrag:!0,rowDrag:!0,columnResize:!0,rowResize:!0,wordWrap:!0,columns:c}]});window.roadmapSpreadsheets[a]=r,console.log("[Roadmap] Spreadsheet initialized with styles:",a)}catch(r){console.error("[Roadmap] Error initializing spreadsheet:",r)}},window.getAllSpreadsheetData=function(a){const n=window.roadmapSpreadsheets[a];if(!n)return console.warn("[Roadmap] No spreadsheet instance found for:",a),null;try{const e=n[0];if(e){const t={cells:e.getData?e.getData():[],style:e.getStyle?e.getStyle():{},mergeCells:e.getMerge?e.getMerge():{},colWidths:[]};try{e.getWidth&&(t.colWidths=e.getWidth())}catch(s){console.warn("[Roadmap] Could not get column widths:",s)}return console.log("[Roadmap] Got full data for",a,":",t),t}return null}catch(e){return console.error("[Roadmap] Error getting data:",e),null}};const u=document.getElementById("flash-success");u&&Swal.fire({icon:"success",title:"Berhasil",text:u.dataset.message,timer:2e3,showConfirmButton:!1});const m=document.getElementById("flash-error");m&&Swal.fire({icon:"error",title:"Gagal",text:m.dataset.message});const p=document.getElementById("saveAllNotesBtn");p&&p.addEventListener("click",function(){const a=document.querySelectorAll('form[action*="save-note"]');if(a.length===0){Swal.fire({icon:"warning",title:"Tidak Ada Form",text:"Tidak ada catatan untuk disimpan."});return}let n=[],e=0;Swal.fire({title:"Menyimpan...",text:"Sedang menyimpan semua catatan",icon:"info",showConfirmButton:!1,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),a.forEach(t=>{const s=t.querySelector('input[name="objective_id"]');if(s){const l=s.value,c=getAllSpreadsheetData(l);console.log("[Roadmap] Saving - Objective:",l,"Spreadsheet Data:",c);const r=t.querySelector('input[name="roadmap_rekomendasi"]');r&&c&&(r.value=JSON.stringify(c))}const o=new FormData(t),i=t.getAttribute("action"),d=fetch(i,{method:"POST",body:o,headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(l=>(l.ok&&e++,l));n.push(d)}),Promise.all(n).then(()=>{Swal.fire({icon:"success",title:"Berhasil!",text:`${e} catatan berhasil disimpan.`,timer:2e3,showConfirmButton:!1})}).catch(t=>{console.error("Error:",t),Swal.fire({icon:"error",title:"Gagal",text:"Terjadi kesalahan saat menyimpan catatan."})})}),console.log("[Roadmap] Initializing spreadsheets..."),document.querySelectorAll('[id^="roadmap-rekomendasi-container-"]').forEach(a=>{const n=a.id.replace("roadmap-rekomendasi-container-","");initSpreadsheet(n)});const h=document.querySelectorAll('form[action*="summary.save-note"]');console.log("[Roadmap] Found forms:",h.length),h.forEach(function(a){a.addEventListener("submit",function(n){const e=a.querySelector('input[name="objective_id"]').value,t=getAllSpreadsheetData(e);console.log("[Roadmap] Form submit - Objective:",e,"Data:",t);const s=a.querySelector('input[name="roadmap_rekomendasi"]');s&&t&&(s.value=JSON.stringify(t))})}),document.querySelectorAll(".btn-group button[data-view]").forEach(a=>{a.addEventListener("click",function(){const n=this.dataset.view,e=this.dataset.target;this.closest(".btn-group").querySelectorAll("button").forEach(i=>{i.classList.remove("active"),i.dataset.view==="gamo"?(i.classList.remove("btn-primary"),i.classList.add("btn-outline-primary")):(i.classList.remove("btn-secondary"),i.classList.add("btn-outline-secondary"))}),this.classList.add("active"),n==="gamo"?(this.classList.remove("btn-outline-primary"),this.classList.add("btn-primary")):(this.classList.remove("btn-outline-secondary"),this.classList.add("btn-secondary"));const s=document.getElementById("view-gamo-"+e),o=document.getElementById("view-practice-"+e);n==="gamo"?(s&&(s.style.display="block"),o&&(o.style.display="none")):(s&&(s.style.display="none"),o&&(o.style.display="block"))})})});
